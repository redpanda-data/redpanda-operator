// Copyright 2026 Redpanda Data, Inc.
//
// Use of this software is governed by the Business Source License
// included in the file licenses/BSL.md
//
// As of the Change Date specified in that file, in accordance with
// the Business Source License, use of this software will be governed
// by the Apache License, Version 2.0

//nolint:gosec // this is a code generation tool
package applyconfigcopy

import "text/template"

type fileImport struct {
	Alias string
	Path  string
}

type copyTemplateData struct {
	InPath        string
	OutPath       string
	TypeString    string
	Alias         string
	SelectorName  string
	PackagePrefix string
	IsStruct      bool
	ElemCopy      string
}

type fileTemplateData struct {
	Header       string
	Package      string
	Imports      []fileImport
	DeepCopyCode string
}

type testTemplateData struct {
	Header     string
	Package    string
	Import     fileImport
	StructName string
}

type deepCopyTemplateData struct {
	StructName    string
	PackagePrefix string
	FieldCopies   string
}

const (
	structTemplateText   = `{{.OutPath}} = {{.PackagePrefix}}{{.TypeString}}{}`
	basicTemplateText    = `{{.OutPath}} = {{.InPath}}`
	selectorTemplateText = `{{.OutPath}} = {{.Alias}}.{{.SelectorName}}`
	arrayTemplateText    = `
if {{.InPath}} != nil {
	{{.OutPath}} = make({{.TypeString}}, len({{.InPath}}))
	{{- if .IsStruct }}
		for i := range {{.InPath}} {
			{{.ElemCopy}}
		}
	{{- else }}
		copy({{.OutPath}}, {{.InPath}})
	{{- end }}
}`
	mapTemplateText = `
if {{.InPath}} != nil {
	{{.OutPath}} = make({{.TypeString}}, len({{.InPath}}))
	for k, v := range {{.InPath}} {
		{{- if .IsStruct }}{{.ElemCopy}}{{- else }}{{.OutPath}}[k] = v{{- end }}
	}
}`
	starTemplateText = `
if {{.InPath}} != nil {
	{{- if .IsStruct }}
		{{.OutPath}} = new({{.PackagePrefix}}{{.TypeString}})
		{{.ElemCopy}}
	{{- else }}
		{{.OutPath}} = new({{.TypeString}})
		 *{{.OutPath}} = *{{.InPath}}
	{{- end }}
}`
	defaultTemplateText = `{{.OutPath}} = {{.InPath}}`
	fileTemplateText    = `// Code generated by gen/copy. DO NOT EDIT.

package {{.Package}}

{{if .Imports}}
import (
{{- range .Imports}}
{{- if and (ne .Alias "") (ne .Alias "_")}}
	{{.Alias}} "{{.Path}}"
{{- else}}
	"{{.Path}}"
{{- end}}
{{- end}}
)
{{end}}

{{.DeepCopyCode}}
`
	testTemplateText = `// Code generated by gen/copy. DO NOT EDIT.
	
package {{.Package}}
import (
	"encoding/json"
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
	"pgregory.net/rapid"
	{{ .Import.Alias }} "{{ .Import.Path }}"

	"github.com/redpanda-data/redpanda-operator/pkg/rapidutil"
)

func TestDeepCopy{{.StructName}}(t *testing.T) {
	rapid.Check(t, func(t *rapid.T) {
		original := rapid.MakeCustom[{{ .Import.Alias }}.{{.StructName}}](rapidutil.KubernetesTypes).Draw(t, "original")

		// Marshal the original
		originalBytes, err := json.Marshal(original)
		require.NoError(t, err)

		// Deep copy
		copy := DeepCopy{{.StructName}}(&original)
		require.NotNil(t, copy)

		// Marshal the copy
		copyBytes, err := json.Marshal(copy)
		require.NoError(t, err)

		// Compare JSON
		assert.JSONEq(t, string(originalBytes), string(copyBytes), "DeepCopy{{.StructName}} did not copy all fields correctly")
	})
}
`
	deepCopyTemplateText = `func DeepCopy{{.StructName}}(in *{{.PackagePrefix}}{{.StructName}}) *{{.PackagePrefix}}{{.StructName}} {
	if in == nil {
		return nil
	}
	out := &{{.PackagePrefix}}{{.StructName}}{}
{{.FieldCopies}}
	return out
}`
)

var (
	structTemplate   *template.Template
	basicTemplate    *template.Template
	selectorTemplate *template.Template
	arrayTemplate    *template.Template
	mapTemplate      *template.Template
	starTemplate     *template.Template
	defaultTemplate  *template.Template
	fileTemplate     *template.Template
	deepCopyTemplate *template.Template
	testTemplate     *template.Template
)

func init() {
	structTemplate = template.Must(template.New("struct").Parse(structTemplateText))
	basicTemplate = template.Must(template.New("basic").Parse(basicTemplateText))
	selectorTemplate = template.Must(template.New("selector").Parse(selectorTemplateText))
	arrayTemplate = template.Must(template.New("array").Parse(arrayTemplateText))
	mapTemplate = template.Must(template.New("map").Parse(mapTemplateText))
	starTemplate = template.Must(template.New("star").Parse(starTemplateText))
	defaultTemplate = template.Must(template.New("default").Parse(defaultTemplateText))
	fileTemplate = template.Must(template.New("file").Parse(fileTemplateText))
	deepCopyTemplate = template.Must(template.New("deepCopy").Parse(deepCopyTemplateText))
	testTemplate = template.Must(template.New("test").Parse(testTemplateText))
}
