version: '3'

# if a task is referenced multiple times, only run it once
run: once

vars:
  SRC_DIR:
    sh: 'realpath {{default "." .SRC_DIR}}'
  BUILD_ROOT:
    sh: 'realpath {{default ".build" .BUILD_ROOT}}'

includes:
  ci: taskfiles/ci.yml
  k8s: taskfiles/k8s.yml
  dev: taskfiles/dev.yml
  goreleaser: taskfiles/goreleaser.yml
  charts: taskfiles/charts.yml

tasks:
  lint:
    vars:
      _PKG:
        sh: go work edit -json | jq -j '[.Use[].DiskPath+"/..."]|join(" ")'
      PKG: '{{default ._PKG .PKG}}'
    cmds:
      - golangci-lint run --timeout 28m {{.PKG}} {{.CLI_ARGS}}
      - ct lint --chart-dirs ./charts --check-version-increment=false --all
      - task: test:unit
        vars:
          PKG: './pkg/lint'
          CLI_ARGS: ''

  lint-fix:
    cmds:
      - task: lint
        vars:
          CLI_ARGS: "--fix"

  mod:tidy:
    cmds:
    - go list -f '{{"{{.Dir}}"}}' -m | xargs -L1 go mod tidy -C
    - go work sync

  fmt:
    cmds:
      - gofumpt -w ./

  generate:
    cmds:
      - task: charts:generate
      # update-licenses may update licenses/boilerplate.go.txt which is used
      # for _some_ of k8s:generate. For simplicity, we just run update-licenses
      # twice.
      - task: dev:update-licenses
      - task: k8s:generate
      - task: dev:update-licenses
      - task: generate:changelog
      - nix fmt # Ensure flake.nix has been formatted.

  generate:changelog:
    generates:
    - charts/*/CHANGELOG.md
    - operator/CHANGELOG.md
    sources:
    - ./changes/**/*.md
    cmds:
    - changie merge -u '## Unreleased' # Ensure CHANGELOG.mds are up to date.

  build:
    cmds:
      - task: build:binaries

  build:binaries:
    cmds:
      # TODO(chrisseto): Ditch goreleaser in favor of just go build in task
      # files. We're not using it for anything other than an arch build matrix.
      - task: goreleaser:build-operator-binaries

  build:images:
    cmds:
      - task: k8s:build-operator-images

  test:unit:
    vars:
      _PKG:
        sh: go work edit -json | jq -j '[.Use[].DiskPath+"/..."]|join(" ")'
      PKG: '{{default ._PKG .PKG}}'
      GO_TEST_RUNNER: '{{default "go test" .GO_TEST_RUNNER}}'
    cmds:
    - '{{.GO_TEST_RUNNER}} {{.CLI_ARGS}} {{.PKG}}'

  test:integration:
    cmds:
    - task: test:unit
      vars:
        GO_TEST_RUNNER:
          ref: .GO_TEST_RUNNER
        CLI_ARGS: '{{.CLI_ARGS}} -run "^TestIntegration" -timeout 20m'
