version: '3'

tasks:
  generate:
    desc: "Run all file generation tasks"
    cmds:
      - task: generate:console
      - task: generate:operator
      - task: generate:redpanda
      - task: generate:multicluster
      - task: generate:connectors
      # Generate chart README.md's
      - helm-docs --chart-to-generate charts/connectors,charts/console/chart,operator/chart,charts/redpanda/chart

  generate:console:
    desc: "Generate files for the console Helm chart"
    deps:
    - task: :build:gen
    cmds:
    - cmd: cd charts/console && gen partial --out zz_generated.config.go --package console --struct Config github.com/redpanda-data/console/backend/pkg/config
    - task: genpartial
      vars: { CHART: console, STRUCT: RenderValues }
    - task: genpartial
      vars: { CHART: console/chart }
    - task: genschema
      vars: { CHART: console, DIR: charts/console/chart }
    - task: gotohelm
      vars: { CHART: console/chart, BUNDLE: ['github.com/redpanda-data/redpanda-operator/charts/console/v3'] }

  generate:operator:
    desc: "Generate files for the operator Helm chart"
    cmds:
    - task: genpartial
      vars: { CHART: operator, DIR: operator/chart }
    - task: genschema
      vars: { CHART: operator, DIR: operator/chart }
    - task: gotohelm
      vars: { CHART: operator, DIR: operator/chart, BUNDLE: ['github.com/redpanda-data/redpanda-operator/pkg/chartutil']}

  generate:multicluster:
    desc: "Generate files for the multicluster operator Helm chart"
    cmds:
    - task: genpartial
      vars: { CHART: multicluster }
    - task: genschema
      vars: { CHART: multicluster }
    - task: gotohelm
      vars: { CHART: multicluster, BUNDLE: ['github.com/redpanda-data/redpanda-operator/pkg/chartutil']}

  generate:redpanda:
    desc: "Generate files for the redpanda Helm chart"
    cmds:
    - task: genpartial
      vars: { CHART: redpanda }
    - task: genschema
      vars: { CHART: redpanda, OUT: ./chart/values.schema.json }
    - task: gotohelm
      vars:
        CHART: redpanda
        OUT: "./chart/templates"
        BUNDLE:
        - github.com/redpanda-data/redpanda-operator/pkg/chartutil
        SUBCHARTS:
        - github.com/redpanda-data/redpanda-operator/charts/console/v3
        - github.com/redpanda-data/redpanda-operator/charts/console/v3/chart

  generate:connectors:
    desc: "Generate files for the connectors Helm chart"
    cmds:
    - task: genpartial
      vars: { CHART: connectors }
    - task: gotohelm
      vars: { CHART: connectors }

  kind-cluster:
    cmds:
      - kind create cluster --config operator/kind-for-v2.yaml

  # Below this line are internal helper tasks that configuring caching for generation tasks.

  genpartial:
    internal: true
    run: when_changed
    label: "genpartial:{{ .CHART }}"
    desc: "Generate a 'partial' version of the Values struct"
    deps:
    - task: :build:gen
    vars:
      CHART: '{{ .CHART }}'
      DIR: '{{ .DIR | default (printf "charts/%s" .CHART ) }}'
      STRUCT: '{{ .STRUCT | default "Values" }}'
    dir: "{{ .DIR }}"
    requires:
      vars: [CHART]
    sources:
    - ./*.go
    - ./**/*.go
    - exclude: ./values_partial.gen.go
    generates:
    - ./values_partial.gen.go
    cmds:
    - gen partial --header {{ .SRC_DIR }}/licenses/boilerplate.go.txt --out ./{{ .STRUCT | lower }}_partial.gen.go --struct {{ .STRUCT }} .

  genschema:
    internal: true
    run: when_changed
    label: "genschema:{{ .CHART }}"
    desc: "Generate the values JSON schema from the Values struct"
    deps:
    - task: :build:gen
    vars:
      CHART: '{{ .CHART }}'
      DIR: '{{ .DIR | default (printf "charts/%s" .CHART ) }}'
      OUT: '{{ .OUT | default "./values.schema.json" }}'
    dir: '{{ .DIR }}'
    requires:
      vars: [CHART]
    sources:
    - ./*.go
    generates:
    - "{{ .OUT }}"
    cmds:
    - gen schema {{ .CHART }} > {{ .OUT }}

  gotohelm:
    internal: true
    run: when_changed
    label: "gotohelm:{{ .CHART }}"
    desc: "Generate helm templates from Go definitions"
    deps:
    - task: :build:gotohelm
    vars:
      CHART: '{{ .CHART }}'
      SUBCHARTS: '{{ .SUBCHARTS | default (list) | join " " }}'
      BUNDLE: '{{ range $bundled := .BUNDLE }} --bundle {{ $bundled }} {{ end }}'
      DIR: '{{ .DIR | default (printf "charts/%s" .CHART ) }}'
      OUT: '{{ .OUT | default "./templates" }}'
    requires:
      vars: [CHART]
    dir: "{{ .DIR }}"
    sources:
    - ./*.go
    - ./**/*.go
    generates:
    - "{{ .OUT }}/*"
    - "{{ .OUT }}/**/*"
    cmds:
    # Generate helm templates from Go definitions
    - gotohelm --write {{ .OUT }} . {{ .SUBCHARTS }} {{ .BUNDLE }}

  download-dependencies:
    desc: "Build out the charts/ directory from the Chart.lock file"
    vars:
      CHART: '{{ .CHART }}'
      DIR: '{{ .DIR | default (printf "charts/%s" .CHART ) }}'
    requires:
      vars: [CHART]
    dir: "{{ .DIR }}"
    sources:
    - ./charts/*
    generates:
    - ./charts/*
    cmds:
    - helm repo add redpanda https://charts.redpanda.com
    - helm dep build .
